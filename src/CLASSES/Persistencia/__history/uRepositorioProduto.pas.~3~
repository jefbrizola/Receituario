{
 -------------------------------------------------------------------------------
 -- Objetivo....: Classe de persistência de objetos TProduto
 -- Autor.......: Jeferson Brizola
 -------------------------------------------------------------------------------
}

unit UntRepositorioProduto;

interface

uses
  uProduto,  SysUtils, dbclient, FireDAC.Comp.Client;

type
  TRepositorioProduto = class
    public
      procedure Insert(pProduto: TProduto);
      procedure Update(pProduto: TProduto);
      procedure Delete(pProduto: TProduto);
      function  getProduto(pCODIGO: string): TProduto;
  end; 

implementation 
                                                                                                                               

function TRepositorioProduto.getProduto(pCODIGO: string): TProduto; 
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
begin                                                                                                                          
  LQry := TFDQuery.Create(nil);
                                                                                                               
  Result := nil;                                                                                               
                                                                                                               
  with LQry do                                                                                                  
  begin                                                                                                        
    try                                                                                                        
      SQL.Text := 'SELECT * FROM PRODUTO ' + #13#10 + 
                 'WHERE CODIGO = :CODIGO'                           ;

      ParamByName('CODIGO' ).AsString  := pCODIGO;
      try
        Open;                                                                                                                          
      except                                                                                                                           
        on E : Exception do                                                                                                            
        begin
          raise Exception.Create('Erro ao consultar Produto' + #13#13 + E.Message);
        end;
      end;
                                                                                                                                      
      if IsEmpty then                                                                                                                  
        raise Exception.Create('Produto inexistente!');                                                 
                                                                                                                                      
      Result := TProduto.Create;                                                                                       

      Result.PRECO := LQry.FieldByName('PRECO').AsString;
      Result.DESCRICAO := LQry.FieldByName('DESCRICAO').AsString;
      Result.CODIGO := LQry.FieldByName('CODIGO').AsString;
      Result.CONTROLE := LQry.FieldByName('CONTROLE').AsString;
    finally                                                                                                                           
      Free;                                                                                                                           
    end;                                                                                                                              
  end;                                                                                                                                
end;                                                                                                                           
                                                                                                                               
function TRepositorioProduto.getProdutos(pCODIGO: string): TApplyCollection;
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
begin                                                                                                                          
  LQry := GetQuery;                                                                                             
                                                                                                               
  Result := nil;                                                                                               
                                                                                                               
  with LQry do                                                                                                  
  begin                                                                                                        
    try                                                                                                        
      SQL.Text := 'SELECT * FROM PRODUTO ' + #13#10 + 
                 'WHERE CODIGO = :CODIGO'                           ;

     ParamByName('CODIGO'                                ).AsString          := pCODIGO;

      try                                                                                                                              
        Open;                                                                                                                          
      except                                                                                                                           
        on E : Exception do                                                                                                            
        begin                                                                                                                          
          g_GravaLogErros('UntRepositorioProduto', 'getProduto', LQry, E);  
          raise Exception.Create('Erro ao consultar Produto' + #13#13 + E.Message);                      
        end;                                                                                                                           
      end;                                                                                                                             
                                                                                                                                       
      if IsEmpty then                                                                                                                  
        raise Exception.Create('Produto inexistente!');                                                 
                                                                                                                                       
      while not(LQry.Eof) do                                                                                                            
      begin                                                                                                                            
        SetLength(Result, Length(Result)+1);                                                                                           
        Result[High(Result)]     := TApplyCollectionObject.Create;                                                                     
        Result[High(Result)].Obj := TProduto.Create;                                                                   
                                                                                                                                       
        (Result[High(Result)].Obj as TProduto).PRECO := LQry.FieldByName('PRECO').AsString;
        (Result[High(Result)].Obj as TProduto).DESCRICAO := LQry.FieldByName('DESCRICAO').AsString;
        (Result[High(Result)].Obj as TProduto).CODIGO := LQry.FieldByName('CODIGO').AsString;
        (Result[High(Result)].Obj as TProduto).CONTROLE := LQry.FieldByName('CONTROLE').AsString;
                                                                                                                                      
        (Result[High(Result)].Obj as TProduto).LoadProperts(TProduto);                                

        LQry.Next;                                                                                                                     
      end;                                                                                                                            

    finally                                                                                                                           
      Free;                                                                                                                           
    end;                                                                                                                              
  end;
end;                                                                                                                           
                                                                                                                               
function TRepositorioProduto.getProdutoList(pCODIGO: string): IFCList<TProduto>;
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
  LProduto: TProduto;
begin                                                                                                                          
  LQry := GetQuery;                                                                                              
                                                                                                               
  Result := nil;                                                                                               
                                                                                                               
  with LQry do                                                                                                  
  begin                                                                                                        
    try                                                                                                        
      SQL.Text := 'SELECT * FROM PRODUTO ' + #13#10 + 
                 'WHERE CODIGO = :CODIGO'                           ;

      ParamByName('CODIGO'                                ).AsString          := pCODIGO;

      try                                                                                                                              
        Open;                                                                                                                          
      except                                                                                                                           
        on E : Exception do                                                                                                            
        begin                                                                                                                          
          g_GravaLogErros('UntRepositorioProduto', 'getProduto', LQry, E);  
          raise Exception.Create('Erro ao consultar Produto' + #13#13 + E.Message);                      
        end;                                                                                                                           
      end;                                                                                                                             
                                                                                                                                       
      if IsEmpty then                                                                                                                  
        raise Exception.Create('Produto inexistente!');                                                 
                                                                                                                                       
      Result := TFCCollection<TProduto>.Create;                                                                        
      while not(LQry.Eof) do                                                                                                            
      begin                                                                                                                            
        LProduto := TProduto.Create;                                                                    
                                                                                                                                       
        LProduto.PRECO := LQry.FieldByName('PRECO').AsString;
        LProduto.DESCRICAO := LQry.FieldByName('DESCRICAO').AsString;
        LProduto.CODIGO := LQry.FieldByName('CODIGO').AsString;
        LProduto.CONTROLE := LQry.FieldByName('CONTROLE').AsString;
                                                                                                                                      
        Result.Add(LProduto);

        LQry.Next;                                                                                                                      
      end;                                                                                                                             

    finally                                                                                                                           
      Free;                                                                                                                           
    end;                                                                                                                              
  end;
end;                                                                                                                           
                                                                                                                               
procedure TRepositorioProduto.Insert(pProduto: TProduto);
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
begin                                                                                                                          
  LQry := GetQuery;                                                                                            
                                                                                                              
  with LQry do                                                                                                 
  begin                                                                                                       
    try                                                                                                       
      SQL.Text := 'INSERT INTO PRODUTO(PRECO                                             , ' + #13#10 + 
                  '                        DESCRICAO                                         , ' + #13#10 + 
                  '                        CODIGO                                            , ' + #13#10 + 
                  '                        CONTROLE) ' + #13#10 + 
                  'VALUES (:PRECO                                             , ' + #13#10 + 
                  '        :DESCRICAO                                         , ' + #13#10 + 
                  '        :CODIGO                                            , ' + #13#10 + 
                  '        :CONTROLE                                          ) '; 

      ParamByName('PRECO'                                 ).AsString          := pProduto.PRECO;
      ParamByName('DESCRICAO'                             ).AsString          := pProduto.DESCRICAO;
      ParamByName('CODIGO'                                ).AsString          := pProduto.CODIGO;
      ParamByName('CONTROLE'                              ).AsString          := pProduto.CONTROLE;

      try                                                                                                                              
        p_ExecutaSql(LQry, Self.FFormulario, Self.FUsuario, Self.FLog);                                                                  
      except                                                                                                                           
        on E : Exception do                                                                                                            
        begin                                                                                                                          
          g_GravaLogErros('UntRepositorioProduto', 'Insert', LQry, E);                 
          raise Exception.Create('Erro ao inserir Produto' + #13#13 + E.Message);                        
        end;                                                                                                                           
      end;                                                                                                                             
    finally                                                                                                                            
      Free;                                                                                                                            
    end;                                                                                                                               
  end;                                                                                                                               
end;                                                                                                                           
                                                                                                                               
procedure TRepositorioProduto.Update(pProduto: TProduto);
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
begin                                                                                                                          
  LQry := GetQuery;                                                                                             
                                                                                                               
  with LQry do                                                                                                  
  begin                                                                                                        
    try                                                                                                        
                                                                                                               
      SQL.Text := 'UPDATE PRODUTO SET ' + #13#10 +                          
                  '  PRECO = :PRECO,' + #13#10 + 
                  '  DESCRICAO = :DESCRICAO,' + #13#10 + 
                  '  CONTROLE = :CONTROLE' + #13#10 + 
                 'WHERE CODIGO = :CODIGO'                           ;


      ParamByName('PRECO').AsString          := pProduto.PRECO;
      ParamByName('DESCRICAO').AsString          := pProduto.DESCRICAO;
      ParamByName('CONTROLE').AsString          := pProduto.CONTROLE;

      try                                                                                                                              
        p_ExecutaSqlUpdate(LQry, Self.FFormulario, Self.FUsuario, Self.FLog, pProduto.ArrProp);                         
      except                                                                                                                           
        on E : Exception do                                                                                                            
        begin                                                                                                                          
          g_GravaLogErros('UntRepositorioProduto', 'Update', LQry, E);                 
          raise Exception.Create('Erro ao atualizar Produto' + #13#13 + E.Message);                      
        end;                                                                                                                           
      end;                                                                                                                             
    finally                                                                                                                            
      Free;                                                                                                                            
    end;                                                                                                                               
  end;                                                                              
end;                                                                                                                           
                                                                                                                               
procedure TRepositorioProduto.Delete(pProduto: TProduto);
var                                                                                                                          
  LQry: TFDQuery;                                                                                                             
begin                                                                                                                          
  LQry := GetQuery;                                                                                             
                                                                                                               
  with LQry do                                                                                                  
  begin                                                                                                        
    try                                                                                                        
      SQL.Text := 'DELETE FROM PRODUTO ' + #13#10 + 
                 'WHERE CODIGO = :CODIGO'                           ;

      ParamByName('CODIGO'                                ).AsString          := pProduto.CODIGO;

      try                                                                                                                
        p_ExecutaSql(LQry, Self.FFormulario, Self.FUsuario, Self.FLog);                                                   
      except                                                                                                             
        on E : Exception do                                                                                              
        begin                                                                                                            
          g_GravaLogErros('UntRepositorioProduto', 'Delete', LQry, E);   
          raise Exception.Create('Erro ao excluir Produto!' + #13#13 + E.Message);      
        end;                                                                                                             
      end;                                                                                                               
    finally                                                                                                               
      Free;                                                                                                               
    end;                                                                                                                  
  end;                                                                                                                    
end;                                                                                                                           
                                                                                                                               
end.                                                                                                  